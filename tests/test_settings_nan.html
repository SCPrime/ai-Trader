<!DOCTYPE html>
<html>
<head>
    <title>Settings NaN Test - No More NaN Values</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { max-width: 1000px; margin: 0 auto; }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
        }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn-warning { background: #ffc107; color: black; border: none; }
        .form-group { margin: 10px 0; }
        input { padding: 8px; margin: 5px; width: 100px; }
        .settings-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .setting-item {
            background: white;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .summary { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üõ°Ô∏è Settings NaN Prevention Test</h1>
        <p>Testing enhanced settings loading with nullish coalescing to eliminate NaN values.</p>

        <div class="test-section">
            <h3>1. üîß Enhanced Settings Loading</h3>
            <p><strong>Features:</strong> Nullish coalescing (??), guaranteed defaults, NaN detection</p>

            <button class="btn-primary" onclick="testSettingsLoading()">
                üì• Test Settings Loading (Enhanced)
            </button>
            <button class="btn-warning" onclick="testWithCorruptedData()">
                ‚ö†Ô∏è Test with Corrupted Data
            </button>
            <div id="loading-result" class="result info">Ready to test settings loading...</div>
        </div>

        <div class="test-section">
            <h3>2. üìä Settings Form Fields</h3>
            <p>All form fields should show valid numbers, no NaN values</p>

            <div class="settings-grid">
                <div class="setting-item">
                    <label>Position Size (%):</label><br>
                    <input type="number" id="positionSize" readonly>
                </div>
                <div class="setting-item">
                    <label>Stop Loss (%):</label><br>
                    <input type="number" id="stopLoss" readonly>
                </div>
                <div class="setting-item">
                    <label>Take Profit (%):</label><br>
                    <input type="number" id="takeProfit" readonly>
                </div>
                <div class="setting-item">
                    <label>Max Daily Loss:</label><br>
                    <input type="number" id="maxDailyLoss" readonly>
                </div>
                <div class="setting-item">
                    <label>Max Positions:</label><br>
                    <input type="number" id="maxPositions" readonly>
                </div>
                <div class="setting-item">
                    <label>Max Daily Trades:</label><br>
                    <input type="number" id="maxDailyTrades" readonly>
                </div>
                <div class="setting-item">
                    <label>AI Confidence:</label><br>
                    <input type="number" id="aiConfidenceThreshold" readonly>
                </div>
                <div class="setting-item">
                    <label>RSI Period:</label><br>
                    <input type="number" id="rsiPeriod" readonly>
                </div>
                <div class="setting-item">
                    <label>SMA Short:</label><br>
                    <input type="number" id="smaShort" readonly>
                </div>
            </div>

            <button class="btn-primary" onclick="validateAllFields()">
                üîç Validate All Fields for NaN
            </button>
            <div id="validation-result" class="result info">Click to validate all form fields...</div>
        </div>

        <div class="summary">
            <h3>üéØ Enhancement Summary</h3>
            <div id="summary-content">
                <p><strong>‚úÖ Nullish Coalescing Implementation:</strong></p>
                <ul>
                    <li>Uses <code>??</code> operator for safe defaults</li>
                    <li>Handles null, undefined, and missing API fields</li>
                    <li>Fallback chain: <code>data.field ?? data.alt_field ?? default</code></li>
                </ul>

                <p><strong>‚úÖ NaN Prevention Features:</strong></p>
                <ul>
                    <li>Triple-layer protection: nullish coalescing + isNaN checks + parseFloat validation</li>
                    <li>Automatic fallback to sensible defaults</li>
                    <li>Robust error handling with applySettingsToUI function</li>
                    <li>Debug logging for troubleshooting</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Mock enhanced settings loading function
        async function testSettingsLoading() {
            try {
                updateResult('loading-result', 'Loading settings from API...', 'info');

                const response = await fetch('/api/settings');
                const data = await response.json();

                // Apply enhanced nullish coalescing approach
                const settings = {
                    stop_loss:     data.stop_loss ?? data.stop_loss_pct ?? 2.0,
                    take_profit:   data.take_profit ?? data.take_profit_pct ?? 5.0,
                    position_size: data.position_size ?? 0.02,
                    max_positions: data.max_positions ?? 5,
                    max_daily_trades: data.max_daily_trades ?? 10,
                    max_daily_loss: data.max_daily_loss ?? 500.0,
                    ai_confidence_threshold: data.ai_confidence_threshold ?? 0.7,
                    rsi_period: data.rsi_period ?? 14,
                    sma_short: data.sma_short ?? 20,
                    sma_long: data.sma_long ?? 50
                };

                console.log('Enhanced settings with defaults:', settings);

                // Apply to UI with additional safety
                applySettingsToUI(settings);

                updateResult('loading-result',
                    '‚úÖ SUCCESS: Settings loaded with nullish coalescing protection',
                    'success'
                );

            } catch (error) {
                updateResult('loading-result',
                    `‚ùå FAILED: ${error.message}`,
                    'error'
                );
            }
        }

        function applySettingsToUI(settings) {
            // Enhanced safe value setter
            const safeSetValue = (elementId, value, defaultValue = 0, multiplier = 1) => {
                const element = document.getElementById(elementId);
                if (element) {
                    const numValue = parseFloat(value);
                    const finalValue = isNaN(numValue) ? defaultValue : numValue * multiplier;
                    element.value = finalValue.toFixed(2);

                    // Log any NaN detection
                    if (isNaN(numValue)) {
                        console.warn(`NaN detected for ${elementId}, using default: ${defaultValue}`);
                    }
                }
            };

            const safeSetIntValue = (elementId, value, defaultValue = 0) => {
                const element = document.getElementById(elementId);
                if (element) {
                    const numValue = parseInt(value);
                    element.value = isNaN(numValue) ? defaultValue : numValue;

                    if (isNaN(numValue)) {
                        console.warn(`NaN detected for ${elementId}, using default: ${defaultValue}`);
                    }
                }
            };

            // Apply all settings with guaranteed non-NaN values
            safeSetValue('positionSize', settings.position_size, 2.0, 100);
            safeSetValue('stopLoss', settings.stop_loss, 2.0, 100);
            safeSetValue('takeProfit', settings.take_profit, 5.0, 100);
            safeSetValue('maxDailyLoss', settings.max_daily_loss, 500.0, 1);
            safeSetIntValue('maxPositions', settings.max_positions, 5);
            safeSetIntValue('maxDailyTrades', settings.max_daily_trades, 10);
            safeSetValue('aiConfidenceThreshold', settings.ai_confidence_threshold, 70.0, 100);
            safeSetIntValue('rsiPeriod', settings.rsi_period, 14);
            safeSetIntValue('smaShort', settings.sma_short, 20);
        }

        async function testWithCorruptedData() {
            updateResult('loading-result', 'Testing with corrupted/missing data...', 'warning');

            // Simulate corrupted API response
            const corruptedData = {
                stop_loss: null,
                take_profit: undefined,
                position_size: "invalid",
                max_positions: NaN,
                // Missing other fields intentionally
            };

            // Apply nullish coalescing
            const settings = {
                stop_loss:     corruptedData.stop_loss ?? corruptedData.stop_loss_pct ?? 2.0,
                take_profit:   corruptedData.take_profit ?? corruptedData.take_profit_pct ?? 5.0,
                position_size: corruptedData.position_size ?? 0.02,
                max_positions: corruptedData.max_positions ?? 5,
                max_daily_trades: corruptedData.max_daily_trades ?? 10,
                max_daily_loss: corruptedData.max_daily_loss ?? 500.0,
                ai_confidence_threshold: corruptedData.ai_confidence_threshold ?? 0.7,
                rsi_period: corruptedData.rsi_period ?? 14,
                sma_short: corruptedData.sma_short ?? 20
            };

            console.log('Recovered from corrupted data:', settings);
            applySettingsToUI(settings);

            updateResult('loading-result',
                '‚úÖ SUCCESS: Corrupted data handled gracefully with defaults',
                'success'
            );
        }

        function validateAllFields() {
            const fieldIds = [
                'positionSize', 'stopLoss', 'takeProfit', 'maxDailyLoss',
                'maxPositions', 'maxDailyTrades', 'aiConfidenceThreshold',
                'rsiPeriod', 'smaShort'
            ];

            let nanCount = 0;
            let validCount = 0;
            const issues = [];

            fieldIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const value = parseFloat(element.value);
                    if (isNaN(value) || element.value === '' || element.value === 'NaN') {
                        nanCount++;
                        issues.push(`${id}: "${element.value}"`);
                    } else {
                        validCount++;
                    }
                }
            });

            if (nanCount === 0) {
                updateResult('validation-result',
                    `‚úÖ PERFECT: All ${validCount} fields have valid numeric values - No NaN detected!`,
                    'success'
                );
            } else {
                updateResult('validation-result',
                    `‚ùå ISSUES FOUND: ${nanCount} fields with NaN/invalid values: ${issues.join(', ')}`,
                    'error'
                );
            }
        }

        function updateResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `result ${type}`;
                element.innerHTML = message;
            }
        }

        // Auto-test on page load
        window.onload = function() {
            console.log('Settings NaN test page loaded');

            // Automatically load settings to demonstrate
            setTimeout(testSettingsLoading, 1000);
        };
    </script>
</body>
</html>